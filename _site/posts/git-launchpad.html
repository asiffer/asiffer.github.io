<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">


	<link rel="stylesheet" href="/css/main.css">
	<link rel="canonical" href="/posts/git-launchpad">
	<link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
		
	<link href='https://fonts.googleapis.com/css?family=Open+Sans rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Muli' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Amatic+SC' rel='stylesheet'>
	<link href="https://fonts.googleapis.com/css?family=Caveat+Brush" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Patrick+Hand" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Patrick+Hand+SC" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Permanent+Marker" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Shadows+Into+Light+Two" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Neucha" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet"> 
	<link href="https://fonts.googleapis.com/css?family=Nanum+Gothic+Coding" rel="stylesheet"> 
	
</head> 

<div id="page">
	<body>
		<header>
			<div class="title">Alban Siffer</div>
		</header>
		<content>
			<div class="aside">
<div class="menu">
 
<a href="/">Home</a>
  
<a href="/bio/">Bio</a>
  
<a href="/research/">Research</a>
  
<a href="/software/">Software</a>
  
<a href="/misc/">Misc</a>
     
</div>

</div>
			<div class="main">
			<div class="subtitle">Distribute your work with Git and Launchpad</div>
			<h1 id="introduction">Introduction</h1>

<p>Let us consider you have developped a nice tool (or a nice library). You make it work on your laptop but, more than that, you put all your code on <a href="https://github.com/">GitHub</a> of <a href="https://about.gitlab.com/">GitLab</a>, for instance. As you are smart, you made a useful <code class="highlighter-rouge">Makefile</code> so as to help others to use your work through the famous process:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://remote.site/mytool.git
<span class="nb">cd </span>mytool/
make
make install
</code></pre></div></div>

<p>However, it looks a bit handmade: of course, you don’t need to be a computer science expert to enter these commands, but this is not as easy as installing an app on your smartphone. Moreover, for all the linux users which can use your work, this is not handled by their package manager: just think about the uninstall or update process …</p>

<p>Obviously, many ways exist to solve these drawbacks. Here we want to explain how you can distribute your work through debian packages and make it available for ubuntu user with a personal package archive (you know the <code class="highlighter-rouge">ppa:/...</code> you can add to your <code class="highlighter-rouge">/etc/apt/sources.list</code>).</p>

<h1 id="step-1-creating-a-debian-package">Step 1: Creating a debian package</h1>

<h2 id="makefile">Makefile</h2>

<p>First we have to ensure one thing: your <code class="highlighter-rouge">Makefile</code> must use an variable <code class="highlighter-rouge">DESTDIR</code> in the installation step. This variable will be used at the package creation. As an example, if you want to install your executable in <code class="highlighter-rouge">/usr/bin</code>, your <code class="highlighter-rouge">Makefile</code> can look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DESTDIR=
default: mytool

mytool:
    ...

install:
    install bin/mytool $(DESTDIR)/usr/bin

clean:
    rm -f bin/mytool

</code></pre></div></div>

<h2 id="skeleton">Skeleton</h2>
<p>Here we consider, we are in your git local repository. It may look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mytool/
    | bin/
    | build/
    | include/
    | src/
    | test/
    | Makefile
</code></pre></div></div>

<p>To create a debian package, we just have to add a <code class="highlighter-rouge">debian/</code> folder (with some specific files) in this layout. We can use <code class="highlighter-rouge">dh_make</code> to do it from scratch (in <code class="highlighter-rouge">mytool/ </code>):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dh_make <span class="nt">-p</span> mytool_1.0 <span class="nt">--createorig</span>
</code></pre></div></div>
<p>Then the type of the package is requeted:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Type of package: (single, indep, library, python)
[s/i/l/p]?
</code></pre></div></div>
<p>If we want to distribute an executable, we just have to select <code class="highlighter-rouge">s</code>. After that, other details are asked:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Maintainer Name     : YOU
Email-Address       : YOU@SOMEWHERE
Date                : Tue, 07 Aug 2018 10:00:00 +0200
Package Name        : mytool
Version             : 1.0
License             : blank
Package Type        : single
Are the details correct? [Y/n/q]
</code></pre></div></div>
<p>These details may depend on your linux configuration. So you can initially accept them. Henceforth, your layout is the following:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| mytool_1.0.orig.tar.xz
| mytool/
    | bin/
    | build/
    | debian/
    | include/
    | src/
    | test/
    | Makefile
</code></pre></div></div>

<h2 id="editing-debian-files">Editing debian/* files</h2>
<p>Now, we have to edit files in the <code class="highlighter-rouge">debian/</code> folder. First there are a lot of examples that we can remove</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>debian/
rm <span class="k">*</span>.ex <span class="k">*</span>.EX
</code></pre></div></div>

<p>Without too much details we have to ensure that the file <code class="highlighter-rouge">source/format</code> contains “<strong>3.0 (native)</strong>” (and not “3.0 (quilt)”). The <em>quilt</em> format use sucessive patches to modify your code from the original <code class="highlighter-rouge">mytool_1.0.orig.tar.xz</code> to your current version. Here we prefer build the package independently (without commiting the package changes etc.), in a kind of snapshot way.</p>

<p>I have also mentionned your personal details in the package initialization. The <code class="highlighter-rouge">control</code> file gatheres these information but also those about the package itself. It look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source: mytool
Section: unknown
Priority: optional
Maintainer: YOU &lt;YOU@SOMEWHERE&gt;
Build-Depends: debhelper (&gt;= 10)
Standards-Version: 4.1.2
Homepage: &lt;insert the upstream URL, if relevant&gt;

Package: mytool
Architecture: any
Depends: ${shlibs:Depends}, ${misc:Depends}
Description: &lt;insert up to 60 chars description&gt;
 &lt;insert long description, indented with spaces&gt;
</code></pre></div></div>

<p>First you can edit the <strong>Maintainer</strong>, <strong>Homepage</strong> and <strong>Description</strong> sections. Then it could be nice to put your work into a common <a href="https://www.debian.org/doc/debian-policy/ch-archive.html#s-subsections">Section</a> (<strong>cli-mono</strong> for instance).</p>

<p>We can also notice the <strong>Build-Depends</strong> and <strong>Depends</strong> sections. In the former, you can precise if you need other packages to build your tool. For instance if you use a library (included in a debian package <code class="highlighter-rouge">libxxx-dev</code>), you can add it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Build-Depends: debhelper (&gt;= 10), libxxx-dev
...
</code></pre></div></div>
<p>The version can be precised in brackets. In the same way, the <strong>Depends</strong> section gives the dependencies to make your tool run:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Depends: ${shlibs:Depends}, ${misc:Depends}, libxxx
...
</code></pre></div></div>
<p>In this latter section, we notice the variables <code class="highlighter-rouge">shlibs:Depends</code> and <code class="highlighter-rouge">misc:Depends</code>. Actually we can use them instead of adding manually  <code class="highlighter-rouge">libxxx</code> (they are defined in the <code class="highlighter-rouge">mytool.substvars</code> file).</p>

<h2 id="first-package">First package</h2>

<p>Once you have modifed the previous files, you are able to build your first package. First you have to add and commit your change with <code class="highlighter-rouge">git</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add debian/
git commit <span class="nt">-m</span> <span class="s2">"Towards a debian package"</span>
</code></pre></div></div>
<p>Then we use <code class="highlighter-rouge">gbp</code> command (from the <code class="highlighter-rouge">git-buildpackage</code> package) to create the debian package. In <code class="highlighter-rouge">mytool/</code> folder:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gbp buildpackage <span class="nt">--git-ignore-new</span>
</code></pre></div></div>
<p>The <code class="highlighter-rouge">git-ignore-new</code> options means that we want to build the package even if some changes have not been commited.
Then you package is ok. But, where is it ? In the parent folder! Your final layout may look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| mytool_1.0.orig.tar.xz
| mytool_1.0-1_amd64.buildinfo
| mytool_1.0-1_amd64.changes
| mytool_1.0-1_amd64.deb
| mytool_1.0-1.dsc
| mytool_1.0-1.tar.xz
| mytool_1.0.orig.tar.xz
mytool/
    | bin/
    | build/
    | debian/
    | include/
    | src/
    | test/
    | Makefile
</code></pre></div></div>

<h1 id="step-2-launchpad">Step 2: Launchpad</h1>

<p>Here we present how to use launchpad to perform automatic ubunutu builds from your code.</p>

<h2 id="a-new-remote-git-repository">A new remote git repository</h2>
<p>Launchpad allows you to create a Personal Package Archive (PPA). You can then distribute softwares and updates directly to Ubuntu users.</p>

<p>To log in to launchpad, you have to create a <a href="https://login.ubuntu.com/">Ubuntu One</a> account. Then you can attach your ssh key
(https://launchpad.net/~USER/+editsshkeys, where USER is your username).
To host your future debian package, you have to create a new PPA (from your launchpad board).</p>

<p>Launchpad will host a remote git repository (the same you have in GitHub or GitLab). So, the idea would be to push your local commit to all your remote repo.
To make it easier, launchpad gives the following advice:
edit <code class="highlighter-rouge">~/.gitconfig</code> and add these lines, where USER is your username:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[url "git+ssh://USER@git.launchpad.net/"]
        insteadof = lp:
</code></pre></div></div>

<p>Now you can add a new repo (called “launchpad”, but you can change it as you like)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote add launchpad lp:~USER/+git/REPOSITORY-NAME
</code></pre></div></div>
<p>where REPOSITORY-NAME is naturally the name you want to give to the repo (generally the same as the others, so “mytool”).</p>

<p>Finally you can push your commits:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push origin master
git push launchpad master
</code></pre></div></div>

<h2 id="recipe">Recipe</h2>
<p>Why using another remote repo?? Actually, launchpad can create <strong>recipes</strong> above your repo. A recipe is just a debian packaging step, a bit like we did in the previous part. The power of launchpad is to automatize it and then host the builded packages.</p>

<p>Let us consider you are in your launchpad account. Go to the “Code” section. Here you may see nothing, in this case, click on “View Git repositories” (or directly https://code.launchpad.net/~USER/+git). Then you will see your repo:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name 	                Status 	        Last Modified 	Last Commit
lp:~USER/+git/mytool 	Development 	... 	        ... 
</code></pre></div></div>

<p>You can click on it and then “Create packaging recipe”. You have to fill some basic information. A noticable thing is the <strong>Default distribution series</strong>: they are the Ubuntu versions for which the package will be built.</p>

<p>Moreover, the text of the recipe can be customized. In particular, you can change the debian versioning scheme. A common pattern is the following: <code class="highlighter-rouge">{debupstream}~{revno}</code> where <code class="highlighter-rouge">debupstream</code> is the classical version (i.e. <code class="highlighter-rouge">1.0</code> is our case) and <code class="highlighter-rouge">revno</code> is a counter incremented at each change.</p>

<p>Actually, all the parameters of the recipe can be changed afterwards.</p>

<p>Finally, on your recipe board (https://code.launchpad.net/~USER/+recipe/RECIPE_NAME) you can request new builds. Once triggered, launchpad notifies the remaining time and after the status of the packaging step (success or fail) with logs.</p>

<p>If it fails, you have to check these logs and investigate errors.</p>

<h2 id="distribute">Distribute</h2>

<p>Once your builds succeed, you have available package in your PPA. For Ubuntu users, then can add your PPA to their <code class="highlighter-rouge">/etc/apt/sources.list</code>. Then they will be able to browse your package, install and update it easily.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>add-apt-repository ppa:USER/REPOSITORY-NAME
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt install mytool
</code></pre></div></div>

<h1 id="step-3-workflow">Step 3: Workflow</h1>

<p>Ok, we have a local git repo and two remote ones (GitHub+Launchpad for example). Builds are made on Launchpad (and are available through yout ppa), but your releases can also be hosted on GitHub.</p>

<h2 id="creating-a-new-version">Creating a new version</h2>

<p>You have your local source code and you make it directly available on your Github repo or through a debian package from your ppa.</p>

<p>Everytime you push to launchpad, it increments the revision number. So initially, launchpad builds <code class="highlighter-rouge">mytool_1.0-1</code> (with the scheme <code class="highlighter-rouge">{debupstream}~{revno}</code>) and then it will build <code class="highlighter-rouge">mytool_1.0-2</code>, <code class="highlighter-rouge">mytool_1.0-3</code> (at the second and third push) etc.</p>

<p>This is very nice because the user could receive these updates through its package manager.
However, you can make many minor commits (not deserving a new version) although sometimes you naturally commit some very huge and useful changes, putting your tool at higher level. At this moment, you want to make a new version!</p>

<p>Once again, we use <code class="highlighter-rouge">gbp</code>. In particular, the command <code class="highlighter-rouge">dch</code> generates Debian changelog entries from git commit messages. It means that all your commits (not registered in the previous version) will be written in the <code class="highlighter-rouge">debian/changelog</code> (this file also embeds the upstream version of your tool).</p>

<p>With the following command, you create a new version of your tool (1.1). It prompts you the changelog file on your favorite terminal text editor. So you can edit and verify all the details.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gbp dch --new-version 1.1
</code></pre></div></div>
<p>If your work is quite stable you can add the <code class="highlighter-rouge">--release</code> option to mark it as a release.
You can also commit the changelog by adding the <code class="highlighter-rouge">--commit</code> option (the default message will be “Update changelog for %(version)s release”).</p>

<h2 id="working-with-github-releases">Working with GitHub releases</h2>

<p>You probably know tha GitHub can manage releases through tags. When you create a new version, the idea would be to create the git tag in the same time so as to create a new package in the launchpad side and a new release on the GitHub side. And you can also upload the .deb packages created on launchpad to the GitHub release (as “release assets”).</p>

<p>The process is the following: add your new code to git, create the new version, commit, tag and push!</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># add your changes
git add -a
# create the new version and commit everything
git dch --new-version X.X --commit
# tag the commit (its name will be "debian/X.X")
gbp buildpackage --git-tag-only
# push the tag
git push origin --tags
git push launchpad --tags
</code></pre></div></div>

<p>Instead of using <code class="highlighter-rouge">gbp</code>, the tag can be done manually. The equivalent is:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git tag -a debian/X.X -m "Update changelog for X.X release"
</code></pre></div></div>

<p>When you push the tag, you can also precise the tag you want to push (the command <code class="highlighter-rouge">--tags</code> push all the tags) through:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push origin debian/X.X
</code></pre></div></div>

<p>Warning: if you push normally on launchpad, a new package is naturally built. If after that you push the tag, some build/upload problems can occur because the revision number did not change (so it cannot replace the previous package with a new package with the same version).</p>

<h2 id="final-workflow">Final workflow</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># you have written new code ...
# you can check locally if your package builds correctly
gbp buildpackage

# if everything is ok, you can add your changes
git add -a

# if you want to create a new version...
# update the changelog (the --commit option will also commit the changes previously added)
git dch --new-version X.X --commit
# create the corresponding tag (its name will be "debian/X.X")
gbp buildpackage --git-tag-only
# then push
git push origin --tags
git push launchpad --tags

# otherwise
git commit -m "your minor changes"
git push origin master
git push launchpad master
</code></pre></div></div>

			</div>
		</content>	
	</body>
	<footer>
	</footer>
</div>
</html>
