<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="We all dream of this world map with cyber attacks between countries like this one or the one of Kaspersky. In this post, we will try to do threat intelligence at our modest level. We will consider a basic system open on the Internet, in the grip of cyber-attackers. In this context, we will collect attacks information so as to make a fancy dashboard to visualize what is going on." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://asiffer.github.io/posts/threat-intel/" />


    <title>
        
            Fancy Threat Intel&#39; with Cowrie/MySQL/Grafana stack :: Alban Siffer 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.d7bdd8ee18bfbf4c605488a7e5b1b92cd980dfeed2bdaeab4dd5e931a7a78bc0.css">


    
        <link rel="stylesheet" type="text/css" href="/css/nord.css">
    

    
        <link rel="stylesheet" type="text/css" href="/css/custom.css">
    





<meta itemprop="name" content="Fancy Threat Intel&#39; with Cowrie/MySQL/Grafana stack">
<meta itemprop="description" content="We all dream of this world map with cyber attacks between countries like this one or the one of Kaspersky. In this post, we will try to do threat intelligence at our modest level. We will consider a basic system open on the Internet, in the grip of cyber-attackers. In this context, we will collect attacks information so as to make a fancy dashboard to visualize what is going on.">
<meta itemprop="datePublished" content="2019-01-25T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-01-25T00:00:00+00:00" />
<meta itemprop="wordCount" content="2503">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fancy Threat Intel&#39; with Cowrie/MySQL/Grafana stack"/>
<meta name="twitter:description" content="We all dream of this world map with cyber attacks between countries like this one or the one of Kaspersky. In this post, we will try to do threat intelligence at our modest level. We will consider a basic system open on the Internet, in the grip of cyber-attackers. In this context, we will collect attacks information so as to make a fancy dashboard to visualize what is going on."/>








    <meta property="article:published_time" content="2019-01-25 00:00:00 &#43;0000 UTC" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">#</span>
            <span class="logo__text">cd /home/∇</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about/">about</a></li><li><a href="/research/">research</a></li><li><a href="/software/">software</a></li><li><a href="/posts/">posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        12 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://asiffer.github.io/posts/threat-intel/">Fancy Threat Intel&rsquo; with Cowrie/MySQL/Grafana stack</a>
      </h1>

      

      
        <hr />
        <aside id="toc">
          <div class="toc-title">Table of Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#context">Context</a></li>
    <li><a href="#cowrie">Cowrie</a>
      <ul>
        <li><a href="#before-installing-cowrie">Before installing cowrie</a></li>
        <li><a href="#getting-sources">Getting sources</a></li>
        <li><a href="#configure">Configure</a></li>
        <li><a href="#start-cowrie">Start cowrie</a></li>
        <li><a href="#caas-cowrie-as-a-service">CAAS: Cowrie As A Service</a></li>
      </ul>
    </li>
    <li><a href="#mysql">MySQL</a>
      <ul>
        <li><a href="#requirements">Requirements</a></li>
        <li><a href="#configuration">Configuration</a></li>
        <li><a href="#back-to-cowrie">Back to cowrie</a></li>
      </ul>
    </li>
    <li><a href="#grafana">Grafana</a>
      <ul>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#configuration-https">Configuration (HTTPS)</a></li>
        <li><a href="#administration">Administration</a></li>
        <li><a href="#first-panels">First panels</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </aside>
        <hr />

      <div class="post-content">
        <p>We all dream of this world map with cyber attacks between countries like this one or the one of <a href="https://cybermap.kaspersky.com/">Kaspersky</a>. In this post, we will try to do threat intelligence at our modest level. We will consider a basic system open on the Internet, in the grip of cyber-attackers. In this context, we will collect attacks information so as to make a fancy dashboard to visualize what is going on.</p>
<p>We will use Cowrie to draw attackers&rsquo; attention (ssh honeypot), MySQL to store the collected data and Grafana to build a dashboard.</p>

    <img src="https://digitalguardian.com/sites/default/files/47275200_m.jpg"  class="left"  style="width: 100%; margin: 1em 0;"  />


<h2 id="context">Context</h2>
<p>In this basic threat intel&rsquo; experiment, we assume having a headless system with a public IP (<code>SERVER_IP</code>) and a domain name (<code>DOMAIN_NAME</code>). We can connect to the server through ssh.</p>
<p>We will first install Cowrie, then MySQL and finally Grafana. Cowrie is a honeypot which will listen on <code>SERVER_IP:22</code>. MySQL will only listen on localhost while Grafana will listen on <code>SERVER_IP:30003</code>.</p>
<h2 id="cowrie">Cowrie</h2>
<p><a href="https://github.com/cowrie/cowrie">Cowrie</a> is a common ssh honeypot aimed to log connection attempts. In particular, we will focus on retrieving the user/password used and also the IP of the attacker.</p>
<p>Several tutorials exist to install cowrie. I have mainly been inspired by <a href="https://eval2a.wordpress.com/2017/12/04/honeypot-part-1-setting-up-cowrie-and-dionaea/">this one</a>.</p>
<h3 id="before-installing-cowrie">Before installing cowrie</h3>
<p>To be a nice system to attack, we have to ensure that our honeypot will listen on port 22. So, as you probably have a ssh server, be sure it is listening on a different port (check /etc/ssh/sshd_config).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">...</span>
<span style="color:#75715e"># The strategy used for options in the default sshd_config shipped with</span>
<span style="color:#75715e"># OpenSSH is to specify options with their default value where</span>
<span style="color:#75715e"># possible, but leave them commented.  Uncommented options override the</span>
<span style="color:#75715e"># default value.</span>

<span style="color:#a6e22e">Port 10022</span>
<span style="color:#75715e">#AddressFamily any</span>
<span style="color:#75715e">#ListenAddress 0.0.0.0</span>
<span style="color:#75715e">#ListenAddress ::</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>Some dependencies are required before installing cowrie. Sorry, it uses python2.7 which will be soon <a href="https://pythonclock.org/">deprecated</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt install git python-virtualenv libssl-dev libffi-dev build-essential libpython-dev python2.7-minimal
</code></pre></div><p>Finally, we need to create the <code>cowrie</code> user. Its home folder will host the logs. However, in my case, I have not so much memory in /home, so I will put everything in another folder, namely /data. So cowrie&rsquo;s home will be at /data/cowrie.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo adduser --home /data/cowrie --disabled-password cowrie
</code></pre></div><p>It may ask you some useless extra information about the user.</p>
<h3 id="getting-sources">Getting sources</h3>
<p>Now, let us take the <code>cowrie</code> identity to download the honeypot files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo su cowrie
$ cd /data/cowrie
$ git clone https://github.com/micheloosterhof/cowrie
</code></pre></div><p>Data are in /data/cowrie/cowrie folder. In this folder, we will create a virtual environment (to avoid installing further python packets on the system).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd cowrie
$ virtualenv cowrie-env
Running virtualenv with interpreter /usr/bin/python2
New python executable in /data/cowrie/cowrie/cowrie-env/bin/python2
Also creating executable in /data/cowrie/cowrie/cowrie-env/bin/python
Installing setuptools, pkg_resources, pip, wheel...done.
</code></pre></div><p>Then, we enter in the virtual environment to download some requirements.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ source cowrie-env/bin/activate
<span style="color:#f92672">(</span>cowrie-env<span style="color:#f92672">)</span> $ pip install --upgrade pip
DEPRECATION: Python 2.7 will reach the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 won<span style="color:#960050;background-color:#1e0010">&#39;</span>t be maintained after that date. A future version of pip will drop support <span style="color:#66d9ef">for</span> Python 2.7.
<span style="color:#f92672">(</span>cowrie-env<span style="color:#f92672">)</span> $ pip install -r requirements.txt --upgrade
...
<span style="color:#f92672">(</span>cowrie-env<span style="color:#f92672">)</span> $ deactivate
</code></pre></div><h3 id="configure">Configure</h3>
<p>Let us recall that we are in the /data/cowrie/cowrie folder. The cowrie config is located in etc/ subfolder. Let us have a look.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd etc/
$ cp cowrie.cfg.dist cowrie.cfg
</code></pre></div><p>Many things can be changed in cowrie.cfg, but we will focus on the most important.</p>
<h4 id="listening-port">Listening port</h4>
<p>In the cowrie.cfg we have especially the port cowrie will listen.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># Endpoint to listen on for incoming SSH connections.</span>
<span style="color:#a6e22e">listen_endpoints</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">tcp:2222:interface=0.0.0.0</span>
</code></pre></div><p>So cowrie is going to listen on tcp port 2222. This is not very interesting to make our system scanned by bots. Several solutions exist.</p>
<h5 id="not-recommended">Not recommended</h5>
<p>Change 2222 to 22 in the config file and run cowrie as root (no, don&rsquo;t do that).</p>
<h5 id="add-bind-capability">Add bind capability</h5>
<p>Change 2222 to 22 in the config file and add bind capabilities to python executable (linux capability <code>CAP_NET_BIND_SERVICE</code>). As your classical user:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo setcap cap_net_bind_service<span style="color:#f92672">=</span>+ep /data/cowrie/cowrie/cowrie-env/bin/python2
</code></pre></div><h5 id="authbind">Authbind</h5>
<p>(see <a href="https://eval2a.wordpress.com/2017/12/04/honeypot-part-1-setting-up-cowrie-and-dionaea/">here</a>)</p>
<h5 id="iptables">iptables</h5>
<p>Finally, you can redirect the port 22 with iptables. As your classical user:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo iptables -t nat -A PREROUTING -p tcp –dport <span style="color:#ae81ff">22</span> -j REDIRECT –to-port <span style="color:#ae81ff">2222</span>
</code></pre></div><p>I have tried iptables and capabilites methods. It works well in both cases.</p>
<h4 id="accepted-connections">Accepted connections</h4>
<p>Cowrie does just log connection but also event about what the attackers do if he manages to connect. WTF!? Don&rsquo;t worry, it is a kind of sandbox. Nowadays, you can configure the accepted credentials through the etc/userdb.txt file (copy userdb.example to userdb.txt before). In my case I have not given any access.</p>
<h3 id="start-cowrie">Start cowrie</h3>
<p>Finally you can start cowrie (the first line is to change the user to cowrie):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo su cowrie
$ cd /data/cowrie/cowrie
$ ./bin/cowrie start

Join the Cowrie community at: http://bit.ly/cowrieslack

Using default Python virtual environment <span style="color:#e6db74">&#34;/data/cowrie/cowrie/cowrie-env&#34;</span>
Starting cowrie: <span style="color:#f92672">[</span>twistd   --umask<span style="color:#f92672">=</span><span style="color:#ae81ff">0022</span> --pidfile<span style="color:#f92672">=</span>var/run/cowrie.pid --logger cowrie.python.logfile.logger cowrie <span style="color:#f92672">]</span>...
</code></pre></div><p>Eventually you can check it works.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./bin/cowrie status
cowrie is running <span style="color:#f92672">(</span>PID: 19133<span style="color:#f92672">)</span>.
$ ss -alt
State  Recv-Q Send-Q Local Address:Port Peer Address:Port
LISTEN <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">50</span>           0.0.0.0:ssh       0.0.0.0:*   
</code></pre></div><p>For the moment you can stop cowrie. We will have a look on some of its options later.</p>
<h3 id="caas-cowrie-as-a-service">CAAS: Cowrie As A Service</h3>
<p>To my mind, managing cowrie is not user-friendly enough. We have to log as the <code>cowrie</code> user and launch <code>/data/cowrie/cowrie/bin/cowrie start</code>. Why not using a systemd service file? Let us create the file <code>cowrie.service</code> in the folder <code>/usr/lib/systemd/system/</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">COWRIE: the famous ssh honeypot!</span>
<span style="color:#a6e22e">Requires</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql.service</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">User</span><span style="color:#f92672">=</span><span style="color:#e6db74">cowrie</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/data/cowrie/cowrie/bin/cowrie start</span>
<span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">on-failure</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p>Now we just have to do:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo systemctl daemon-reaload
$ sudo systemctl start cowrie
</code></pre></div><p>If you check the service (<code>sudo systemctl status cowrie</code>), it is actually idle&hellip; Why? The file <code>/data/cowrie/cowrie/bin/cowrie</code> is in fact a shell script which manage and daemonize the real underlying program. To solve the problem, we need to change a variable at the beginning of the file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">...</span>
<span style="color:#a6e22e">DAEMONIZE</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-n&#34;</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>Now you can start your service (even enable it at boot time)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo systemctl start cowrie
$ sudo systemctl enable cowrie
</code></pre></div><h2 id="mysql">MySQL</h2>
<p>We will use MySQL to store the cowrie logs. First we set up a MySQL server and then we configure cowrie to send logs to the database.
Many of these steps are detailed in /data/cowrie/cowrie/docs/sql/README.rst.</p>
<h3 id="requirements">Requirements</h3>
<p>First let us download the mysql utilities.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt install mysql-server mysql-client mysql-common libmysqlclient-dev
</code></pre></div><h3 id="configuration">Configuration</h3>
<p>First you can start the secure installation of mysql. It helps to remove some useless (and insecure) features.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mysql_secure_installation 
</code></pre></div><p>Then you can add a cowrie user, a database just for him (and all privilege on it).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo mysql
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;cowrie&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;cowrie&#39;</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> cowrie;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> cowrie.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;cowrie&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
mysql<span style="color:#f92672">&gt;</span> FLUSH <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><p>After you can check that the connection with the cowrie&rsquo;s account is ok</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mysql -u cowrie -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or <span style="color:#ae81ff">\g</span>.
...
</code></pre></div><h3 id="back-to-cowrie">Back to cowrie</h3>
<p>Cowrie can send logs to a mysql database. First we have to add a python package (to the virtual environment obviously):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo su cowrie
$ cd /data/cowrie/cowrie
$ source cowrie-env/bin/activate
<span style="color:#f92672">(</span>cowrie-env<span style="color:#f92672">)</span> $ pip install mysql-python --upgrade
</code></pre></div><p>Then, the config file of cowrie (/data/cowrie/cowrie/etc/cowrie.cfg) must be modified as follows (according to your MySQL installation).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">...</span>
<span style="color:#75715e"># MySQL logging module</span>
<span style="color:#75715e"># Database structure for this module is supplied in docs/sql/mysql.sql</span>
<span style="color:#75715e"># </span>
<span style="color:#75715e"># MySQL logging requires extra software: sudo apt-get install libmysqlclient-dev</span>
<span style="color:#75715e"># MySQL logging requires an extra Python module: pip install mysql-python</span>
<span style="color:#75715e"># </span>
<span style="color:#66d9ef">[output_mysql]</span>
<span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true  </span>
<span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost </span>
<span style="color:#a6e22e">database</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">cowrie</span>
<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">cowrie</span>
<span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">cowrie</span>
<span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3306</span>
<span style="color:#a6e22e">debug</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">false</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>Now, the database scheme required by cowrie must be loaded in MySQL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd /data/cowrie/cowrie/docs/sql
$ mysql -u cowrie -p
Enter password: 
...
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> USE cowrie;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">source</span> mysql.<span style="color:#66d9ef">sql</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> tables;
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_cowrie <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> auth             <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> clients          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> downloads        <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> <span style="color:#66d9ef">input</span>            <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> keyfingerprints  <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> params           <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> sensors          <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> sessions         <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> ttylog           <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">------------------+
</span><span style="color:#75715e"></span>mysql<span style="color:#f92672">&gt;</span> EXIT
</code></pre></div><h2 id="grafana">Grafana</h2>
<h3 id="installation">Installation</h3>
<p>Some details can be found on the <a href="https://docs.grafana.org/installation/debian/">grafana website</a>. Unfortunately, you cannot use <code>apt</code> directly to get it, so you have either to download it manually or add their apt repository (see below).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo nano /etc/apt/sources.list.d/grafana.list
</code></pre></div><p>Add the following line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">deb https://packages.grafana.com/oss/deb stable main
</code></pre></div><p>To install singed packages:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl https://packages.grafana.com/gpg.key | sudo apt-key add -
</code></pre></div><p>Then install it!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install grafana
</code></pre></div><h3 id="configuration-https">Configuration (HTTPS)</h3>
<p>Before doing fancy visualizations with Grafana, we need to set up a bit of security. Actually, everything is local: cowrie listens on port 22 but this is a sandbox (besides we do not accept any connection in this case) and MySQL is listening on localhost.</p>
<p>Let us recall that we are headless so Grafana is likely to be our single entry point from the internet. As it has a full HTTP API, we first set up HTTPS, and then we create fancy dashboards.</p>
<p>Naturally, we will use <a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-other">Certbot</a> to generate SSL certificates. We can add the cerbot ppa on our system so as to install it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt update
$ sudo apt install certbot 
</code></pre></div><p>With certbot we can easily create a certificate for our <code>DOMAIN_NAME</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo certbot certonly --standalone -d DOMAIN_NAME
...
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/DOMAIN_NAME/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/DOMAIN_NAME/privkey.pem
   Your cert will expire on 2019-04-28. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   <span style="color:#e6db74">&#34;certbot renew&#34;</span>
...
</code></pre></div><p>We have the materials to make the connection to Grafana encryted. Let us open the configuration file (/etc/grafana/grafana.ini).
In particular we have to set the protocol to https, the port to 30003, the domain name and the certificate/key files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">...</span>
<span style="color:#66d9ef">[server]</span>
<span style="color:#75715e"># Protocol (http, https, socket)</span>
<span style="color:#a6e22e">protocol</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">https</span>

<span style="color:#75715e"># The ip address to bind to, empty will bind to all interfaces</span>
<span style="color:#75715e">;http_addr =</span>

<span style="color:#75715e"># The http port  to use</span>
<span style="color:#a6e22e">http_port</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">30003</span>

<span style="color:#75715e"># The public facing domain name used to access grafana from a browser</span>
<span style="color:#a6e22e">domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">DOMAIN_NAME</span>

<span style="color:#75715e"># Redirect to correct domain if host header does not match domain</span>
<span style="color:#75715e"># Prevents DNS rebinding attacks</span>
<span style="color:#75715e">;enforce_domain = false</span>

<span style="color:#75715e"># The full public facing url you use in browser, used for redirects and emails</span>
<span style="color:#75715e"># If you use reverse proxy and sub path specify full url (with sub path)</span>
<span style="color:#75715e">;root_url = http://localhost:3000</span>
<span style="color:#a6e22e">...</span>
<span style="color:#75715e"># https certs &amp; key file</span>
<span style="color:#a6e22e">cert_file</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/etc/letsencrypt/live/DOMAIN_NAME/cert.pem</span>
<span style="color:#a6e22e">cert_key</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/etc/letsencrypt/live/DOMAIN_NAME/privkey.pem</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>If you start your server, you may have an error: grafana cannot read your certificate files (cert/key). Actually, only root can read them while the Grafana service (file /usr/lib/systemd/system/grafana-server.service) run as <code>grafana</code> user (and <code>grafana</code> group). Two solutions exist (see the following paragraphs)</p>
<h5 id="lazy-and-ugly">Lazy and ugly</h5>
<p>You give read + exec access to all for the folders <code>/etc/letsencrypt/live</code> and <code>/etc/letsencrypt/archive</code> (the most insecure)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo chmod -R a+rw /etc/letsencrypt/live
$ sudo chmod -R a+rw /etc/letsencrypt/archive
</code></pre></div><h5 id="boring-and-secure">Boring and secure</h5>
<p>You create a specific group for ssl stuff (e.g. <code>ssl-users</code>) and add grafana to it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo groupadd ssl-users
$ sudo usermod -aG ssl-users grafana
$ sudo chown -R root:ssl-users /etc/letsencrypt
$ sudo chmod -R g+rw /etc/letsencrypt/live
$ sudo chmod -R g+rw /etc/letsencrypt/archive
</code></pre></div><p>With the second solution, the problem is not solved yet. Actually, the service runs with the group <code>grafana</code> (and not <code>ssl-users</code>), so we have to remove it (in /usr/lib/systemd/system/grafana-server.service):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Grafana instance</span>
<span style="color:#a6e22e">Documentation</span><span style="color:#f92672">=</span><span style="color:#e6db74">http://docs.grafana.org</span>
<span style="color:#a6e22e">Wants</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">postgresql.service mariadb.service mysql.service</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/etc/default/grafana-server</span>
<span style="color:#a6e22e">User</span><span style="color:#f92672">=</span><span style="color:#e6db74">grafana</span>
<span style="color:#75715e">#Group=grafana</span>
<span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">simple</span>
<span style="color:#a6e22e">...</span>
</code></pre></div><p>When a service file is changed, we must reload them:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl daemon-reload
</code></pre></div><p>Damned! It creates a new problem: <code>/etc/grafana</code> is owned by root:grafana, so the daemon cannot read the config file&hellip; You must change to grafana:grafana:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo chown -R grafana:grafana /etc/grafana
</code></pre></div><p>We are done, you can check the status of the service:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo service grafana-server status 
● grafana-server.service - Grafana instance
    Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/grafana-server.service; disabled vendor preset: enabled<span style="color:#f92672">)</span>
    Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since Mon 2019-01-28 12:43:54 UTC; 15min ago
    ...
</code></pre></div><h3 id="administration">Administration</h3>
<p>Finally! We did it! Let us connect to <code>https://DOMAIN_NAME:30003/</code>:

    <img src="/images/threat-intel/grafana_welcome.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</p>
<p>Now, you can connect to Grafana. Default credentials are admin/admin, but Grafana ask you to change once logged in, so&hellip; DO IT!</p>
<p>Then, on the main dashboard, Grafana invites us to add a data source. So, let&rsquo;s do this:</p>
<table>
<thead>
<tr>
<th>Home dashboard</th>
<th>Data source selection</th>
</tr>
</thead>
<tbody>
<tr>
<td>
    <img src="/images/threat-intel/grafana_home.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</td>
<td>
    <img src="/images/threat-intel/grafana_data_source.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</td>
</tr>
</tbody>
</table>
<p>Naturally, we select MySQL and we fill the required information:

    <img src="/images/threat-intel/grafana_mysql.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</p>
<p>After that, we are ready to make a fancy dashboard with fancy panels to visualize what is going on in our cowrie honeypot!</p>
<h3 id="first-panels">First panels</h3>
<p>Grafana have different built-in panels but you can get more through <a href="https://grafana.com/plugins">plugins</a>. In particular we will use the &ldquo;carpet-plot&rdquo;, which will represent the number of ssh connection attempts, every hour, along time. We can download it through:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo grafana-cli plugins install petrslavotinek-carpetplot-panel
</code></pre></div><p>Once the plugin is installed, you must restart Grafana.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo service grafana-server restart
</code></pre></div><h4 id="last-credentials">Last credentials</h4>
<p>One interesting thing is to get the last credentials the attackers used to connect to our honey pot. A simple &ldquo;Table&rdquo; panel can do the job.</p>
<p>To configure the panel, you have to make the right SQL query. Here, this is not so complicated as these information are stored in the <code>auth</code> table of the <code>cowrie</code> database. You can either use the query interface or put the raw query (<code>Toggle Edit Mode</code>).</p>
<p>In my point of view, the interface is better to manage time queries/aggregations. If you want simple output (no time filter), the edit mode is easier. So let us use it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">timestamp</span>,username,password <span style="color:#66d9ef">from</span> auth
</code></pre></div>
    <img src="/images/threat-intel/grafana_panel_cred2.png"  class="left"  style="width: 100%; margin: 1em 0;"  />


<p>Now, you can configure further things like the title or the way to sort the data (descending time order in my case).</p>
<h4 id="number-of-unique-ip-addresses">Number of unique IP addresses</h4>
<p>The first panel is greedy, meaning that it has printed all the credentials since the beginning. However, Grafana is designed to work on sliding window. Here, we answer the following question: &ldquo;How many distinct IP addresses have attempted to connect for the last <code>x</code> days?&rdquo;, where <code>x</code> is a parameter you can tune on the top-right corner of the dashboard.</p>
<p>For that purpose, let us add a new &ldquo;Singlestat&rdquo; panel, designed to print a relevant value.

    <img src="/images/threat-intel/grafana_panel_distinct_ip.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</p>
<p>IP are stored in the <code>sessions</code> table.
Here, we have to count the distinct IP but only for the last <code>x</code> days. This filter is easily available through <code>$__timeFilter</code>. The whole command is then:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">COUNT</span>(<span style="color:#66d9ef">DISTINCT</span> ip) <span style="color:#66d9ef">FROM</span> sessions <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">$</span>__timeFilter(starttime)
</code></pre></div><h4 id="attacking-periods">Attacking periods</h4>
<p>What time are we under attack? To go further in our threat intelligence experiment, we are going to use the &ldquo;carpet plot&rdquo; we downloaded previously.</p>
<p>Here, the query interface seems easier to use, especially if (like me) you are not mastering SQL.

    <img src="/images/threat-intel/grafana_panel_carpet3.png"  class="left"  style="width: 100%; margin-bottom: 1em;"  />

</p>
<p>Naturally, you can change the title, the color palette etc. Grafana and its plugins are pretty good for customization.</p>
<h4 id="i-want-the-world-map">I want the world map!</h4>
<p>Obsiously, we want the map. Unfortunately, the Grafana plugin is not so easy to use with our information. I will do my best to find
a simple solution to do it from our setup.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->

      </div>
    </article>

    <hr />

    <div class="post-info">
      
      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        2503 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2019-01-25 01:00
        

         
          
        
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h"></span>
          <hr />
        </div>

        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="https://asiffer.github.io/posts/nmap-ml/">
                <span class="button__icon">←</span>
                <span class="button__text">Machine Learning in Nmap</span>
              </a>
            </span>
          

          
            <span class="button next">
              <a href="https://asiffer.github.io/posts/launchpad/">
                <span class="button__text">Distribute your work with Git and Launchpad</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
            <span><a href="https://asiffer.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.af435e44374f1e99a669ea8cd5bb9a2fceed80588941a451bfddb66b86a67c9f40b0f417e9543a763f809aa7e9300d7b1d69bf99615810ba02ac70396d50fad5.js" integrity="sha512-r0NeRDdPHpmmaeqM1buaL87tgFiJQaRRv922a4amfJ9AsPQX6VQ6dj&#43;AmqfpMA17HWm/mWFYELoCrHA5bVD61Q=="></script>



    </body>
</html>
